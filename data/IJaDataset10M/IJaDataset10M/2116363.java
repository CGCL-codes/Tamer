package eu.planets_project.pp.plato.services.action.crib_integration;

import java.rmi.RemoteException;
import java.util.LinkedList;
import javax.ejb.EJBException;
import javax.xml.rpc.ServiceException;
import org.apache.commons.logging.Log;
import eu.planets_project.pp.plato.model.FormatInfo;
import eu.planets_project.pp.plato.model.Parameter;
import eu.planets_project.pp.plato.model.PreservationActionDefinition;
import eu.planets_project.pp.plato.model.SampleObject;
import eu.planets_project.pp.plato.services.PlatoServiceException;
import eu.planets_project.pp.plato.services.action.IMigrationAction;
import eu.planets_project.pp.plato.services.action.MigrationResult;
import eu.planets_project.pp.plato.services.crib_integration.remoteclient.Criterion;
import eu.planets_project.pp.plato.services.crib_integration.remoteclient.FileObject;
import eu.planets_project.pp.plato.services.crib_integration.remoteclient.MetaconverterServiceLocator;
import eu.planets_project.pp.plato.services.crib_integration.remoteclient.Metaconverter_PortType;
import eu.planets_project.pp.plato.services.crib_integration.remoteclient.MigrationPath;
import eu.planets_project.pp.plato.services.crib_integration.remoteclient.RepresentationObject;
import eu.planets_project.pp.plato.util.PlatoLogger;

/**
 * A common action interface for all CRiB migration services located at http://crib.dsi.uminho.pt
 *  
 * @author Michael Kraxner
 *
 */
public class CRiBActionServiceLocator implements IMigrationAction {

    private MetaconverterServiceLocator metaconverterServiceLocator;

    private Metaconverter_PortType metaconverterService;

    private MigrationResult lastResult;

    private static final Log log = PlatoLogger.getLogger(CRiBActionServiceLocator.class);

    public CRiBActionServiceLocator() {
        metaconverterServiceLocator = new MetaconverterServiceLocator();
    }

    public MigrationResult getLastResult() {
        return lastResult;
    }

    public MigrationResult migrate(PreservationActionDefinition action, SampleObject sampleObject) throws PlatoServiceException {
        if (perform(action, sampleObject)) {
            return lastResult;
        }
        return null;
    }

    private String getCriterion(Criterion[] criteria, String name) {
        if (name == null || criteria == null) return null;
        int idx = 0;
        while (idx < criteria.length) {
            if (name.equals(criteria[idx].getName())) return criteria[idx].getValue();
            idx++;
        }
        return null;
    }

    /**
     * Migrates sample record <code>sampleObject</code>  with the migration action  defined in <code>action</code>.
     *  
     */
    public boolean perform(PreservationActionDefinition action, SampleObject sampleObject) throws PlatoServiceException {
        try {
            metaconverterService = metaconverterServiceLocator.getMetaconverter();
            FileObject sampleFile = new FileObject(sampleObject.getData().getData(), sampleObject.getFullname());
            RepresentationObject representationObject = new RepresentationObject(new FileObject[] { sampleFile });
            MigrationPath migrationPath = new MigrationPath();
            LinkedList<String> urls = new LinkedList<String>();
            for (Parameter param : action.getParams()) {
                urls.add(param.getValue());
            }
            String[] urlArr = urls.toArray(new String[] {});
            migrationPath.setAccessPoints(urlArr);
            eu.planets_project.pp.plato.services.crib_integration.remoteclient.MigrationResult migrationResult = metaconverterService.convert(representationObject, migrationPath);
            MigrationResult result = new MigrationResult();
            lastResult = result;
            Criterion[] criteria = migrationResult.getReport().getCriteria();
            double availability = Double.parseDouble(getCriterion(criteria, "process::availability"));
            double stability = Double.parseDouble(getCriterion(criteria, "process::stability"));
            result.setSuccessful((availability > 0.0) && (stability > 0.0));
            if (!result.isSuccessful()) {
                result.setReport(String.format("Service '%s' failed to migrate sample '%s'.", action.getShortname(), sampleObject.getFullname()));
                log.debug(String.format("Service '%s' failed to migrate sample '%s': %s", action.getShortname(), sampleObject.getFullname(), getCriterion(criteria, "message::reason")));
                return true;
            } else {
                result.setReport(String.format("Migrated object '%s' to format '%s'. Completed at %s.", sampleObject.getFullname(), action.getTargetFormat(), migrationResult.getReport().getDatetime()));
            }
            result.getMigratedObject().getData().setData(migrationResult.getRepresentation().getFiles()[0].getBitstream().clone());
            String filename = migrationResult.getRepresentation().getFiles()[0].getFilename();
            if ((filename == null) || "".equals(filename)) {
                filename = sampleObject.getFullname();
                int bodyEnd = filename.lastIndexOf(".");
                if (bodyEnd >= 0) filename = filename.substring(0, bodyEnd);
            }
            result.getMigratedObject().setFullname(filename);
            int bodyEnd;
            bodyEnd = filename.lastIndexOf(".");
            if ((bodyEnd < 0) && ((result.getTargetFormat().getDefaultExtension() == null) || "".equals(result.getTargetFormat().getDefaultExtension()))) {
                FormatInfo targetFormat = new FormatInfo();
                setFormatFromCRiBID(action.getTargetFormat(), targetFormat);
                result.setTargetFormat(targetFormat);
                filename = filename + "." + result.getTargetFormat().getDefaultExtension();
                result.getMigratedObject().setFullname(filename);
            }
            lastResult = result;
            return true;
        } catch (NumberFormatException e) {
            throw new PlatoServiceException("Migration failed, CRiB returned an invalid result.", e);
        } catch (RemoteException e) {
            throw new PlatoServiceException("Migration failed, could not access CRiB.", e);
        } catch (ServiceException e) {
            throw new PlatoServiceException("Migration failed, could not access CRiB.", e);
        } catch (EJBException e) {
            throw new PlatoServiceException("Migration failed, could not access CRiB.", e);
        }
    }

    /**
     * Sets default extension and mime type of <code>format</code> according to the provided
     * <code> cribID</code>. 
     */
    private void setFormatFromCRiBID(String cribID, FormatInfo format) {
        String id = cribID.toUpperCase();
        if (id.indexOf("JPEG 2000") >= 0) {
            format.setDefaultExtension("jp2");
            format.setMimeType("image/jpeg");
        } else if (id.indexOf("JPEG") >= 0) {
            format.setDefaultExtension("jpg");
            format.setMimeType("image/jpeg");
        } else if (id.indexOf("PORTABLE NETWORK GRAPHICS") >= 0) {
            format.setDefaultExtension("png");
            format.setMimeType("image/png");
        } else if (id.indexOf("TAGGED IMAGE FILE") >= 0) {
            format.setDefaultExtension("tiff");
            format.setMimeType("image/tiff");
        } else if (id.indexOf("BITMAP") >= 0) {
            format.setDefaultExtension("bmp");
            format.setMimeType("image/bmp");
        } else if (id.indexOf("PORTABLE DOCUMENT FORMAT") >= 0) {
            format.setDefaultExtension("pdf");
            format.setMimeType("application/pdf");
        } else if (id.indexOf("PLAIN TEXT") >= 0) {
            format.setDefaultExtension("txt");
            format.setMimeType("text/plain");
        } else if (id.indexOf("GRAPHICS INTERCHANGE FORMAT") >= 0) {
            format.setDefaultExtension("gif");
            format.setMimeType("image/gif");
        } else if (id.indexOf("MICROSOFT WORD FOR WINDOWS DOCUMENT") >= 0) {
            format.setDefaultExtension("doc");
            format.setMimeType("application/doc");
        }
    }
}
