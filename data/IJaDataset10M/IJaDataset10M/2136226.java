package org.eaasyst.search.apps;

import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import javax.servlet.http.HttpServletRequest;
import org.apache.struts.action.ActionForm;
import org.eaasyst.eaa.apps.CopyApplicationBase;
import org.eaasyst.eaa.data.DataConnector;
import org.eaasyst.eaa.security.UserProfileManager;
import org.eaasyst.eaa.syst.data.persistent.SavedSearch;
import org.eaasyst.eaa.syst.data.persistent.SavedSearchFilter;
import org.eaasyst.eaa.syst.data.persistent.SavedSearchUser;
import org.eaasyst.eaa.utils.StringUtils;
import org.eaasyst.search.data.impl.SavedSearchDabFactory;
import org.eaasyst.search.forms.SavedSearchForm;

/**
 * <p>This applications creates a new Saved Search from an existing one.</p>
 * 
 * @version 2.9
 * @author Jeff Chilton
 */
public class SavedSearchCopy extends CopyApplicationBase {

    /**
	 * <p>Constructs a new "SavedSearchCopy" object.</p>
	 *
	 * @since Eaasy Street 2.3   
	 */
    public SavedSearchCopy() {
        className = StringUtils.computeClassName(getClass());
        setKeyFieldName("id");
        setKeyAutoGenerated(true);
        setKeyNumeric(true);
        setAccessBeanFactory(new SavedSearchDabFactory());
    }

    /**
	 * Returns a HashMap object containing the required parameters for
	 * the data access bean update/insert command.
	 *
	 * @param req the <code>HttpServletRequest</code> object
	 * @return the data access bean update parameters
	 * @since Eaasy Street 2.3
	 */
    protected Map getUpdateParameters(HttpServletRequest req, Object rawData, ActionForm actionForm) {
        Map parameters = new HashMap();
        SavedSearch savedSearch = (SavedSearch) rawData;
        SavedSearch savedSearchCopy = new SavedSearch();
        Date rightNow = new Date();
        String userId = UserProfileManager.getUserId();
        savedSearchCopy.setId(-1);
        savedSearchCopy.setName(savedSearch.getName() + " (copy)");
        savedSearchCopy.setCreationDate(rightNow);
        savedSearchCopy.setCreatedBy(userId);
        savedSearchCopy.setLastUpdate(rightNow);
        savedSearchCopy.setLastUpdateBy(userId);
        savedSearchCopy.setDescription(savedSearch.getDescription());
        savedSearchCopy.setApplication(savedSearch.getApplication());
        savedSearchCopy.setSortBy(savedSearch.getSortBy());
        savedSearchCopy.setSearchDefinition(savedSearch.getSearchDefinition());
        if (savedSearch.getSavedSearchFilter() != null) {
            Set filters = new HashSet();
            Iterator i = savedSearch.getSavedSearchFilter().iterator();
            while (i.hasNext()) {
                SavedSearchFilter filter = (SavedSearchFilter) i.next();
                SavedSearchFilter copyFilter = new SavedSearchFilter();
                copyFilter.setId(-1);
                copyFilter.setFieldName(filter.getFieldName());
                copyFilter.setFilterType(filter.getFilterType());
                copyFilter.setFieldValue(filter.getFieldValue());
                copyFilter.setCreationDate(rightNow);
                copyFilter.setCreatedBy(userId);
                copyFilter.setLastUpdate(rightNow);
                copyFilter.setLastUpdateBy(userId);
                copyFilter.setSavedSearch(savedSearchCopy);
                filters.add(copyFilter);
            }
            savedSearchCopy.setSavedSearchFilter(filters);
        }
        Set owners = new HashSet();
        SavedSearchUser owner = new SavedSearchUser();
        owner.setSavedSearch(savedSearchCopy);
        owner.setAuthority(SavedSearchUser.OWNER_AUTHORITY);
        owner.setUserId(userId);
        owner.setCreationDate(rightNow);
        owner.setCreatedBy(userId);
        owner.setLastUpdate(rightNow);
        owner.setLastUpdateBy(userId);
        owners.add(owner);
        savedSearchCopy.setUser(owners);
        parameters.put(DataConnector.RECORD_PARAMETER, savedSearchCopy);
        return parameters;
    }

    /**
	 * <p>Returns a blank Struts <code>ActionForm</code> configured for
	 * this application.</p>
	 *
	 * @return a blank Struts <code>ActionForm</code> configured for
	 * this application
	 * @since Eaasy Street 2.3
	 */
    protected ActionForm getBlankForm() {
        return new SavedSearchForm();
    }

    /**
	 * Returns a populated Struts <code>ActionForm</code>.
	 * 
	 * @return a populated Struts <code>ActionForm</code>
	 * @since Eaasy Street 2.3
	 */
    protected ActionForm populateActionForm(Object rawData) {
        return new SavedSearchForm((SavedSearch) rawData);
    }
}
