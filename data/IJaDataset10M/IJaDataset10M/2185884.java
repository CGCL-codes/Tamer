package hu.rsc.svnAdmin;

import hu.rsc.svnAdmin.engine.view.SvnEntityPermission;
import hu.rsc.svnAdmin.engine.view.SvnGroup;
import hu.rsc.svnAdmin.engine.view.SvnUser;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import javax.swing.DefaultListModel;
import javax.swing.JDialog;
import javax.swing.JFrame;
import javax.swing.JOptionPane;
import javax.swing.ListModel;

/**
 *
 * @author tircsil
 */
public class UsersAndGroupsView extends javax.swing.JPanel {

    JDialog userDialog = null;

    private SvnGroup selectedGroup = null;

    /** Creates new form UsersAndGroupsView */
    public UsersAndGroupsView() {
        initComponents();
        resetComponents();
        updateUsers();
    }

    private void resetComponents() {
        groupsCb.removeAllItems();
        groupsCb.addItem(null);
        int index = 1;
        for (SvnGroup group : SVNAdminView.engine.getGroups()) {
            groupsCb.addItem(group);
            if (selectedGroup != null && selectedGroup.equals(group)) {
                groupsCb.setSelectedIndex(index);
            }
            index++;
        }
        groupsCb.addItemListener(new ItemListener() {

            public void itemStateChanged(ItemEvent ie) {
                selectedGroup = (SvnGroup) ie.getItem();
                UsersAndGroupsView.this.updateUsers();
            }
        });
    }

    public void updateComponents() {
        resetComponents();
        updateUsers();
    }

    private void updateUsers() {
        availableUsers.removeAll();
        DefaultListModel model = new DefaultListModel();
        for (SvnUser user : SVNAdminView.engine.getUsers()) {
            model.addElement(user);
        }
        availableUsers.setModel(model);
        members.removeAll();
        if (selectedGroup != null) {
            model = new DefaultListModel();
            for (SvnUser user : selectedGroup.getMembers()) {
                model.addElement(user);
            }
            members.setModel(model);
        }
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    private void initComponents() {
        jScrollPane1 = new javax.swing.JScrollPane();
        availableUsers = new javax.swing.JList();
        jScrollPane2 = new javax.swing.JScrollPane();
        members = new javax.swing.JList();
        groupsCb = new javax.swing.JComboBox();
        addGroupBt = new javax.swing.JButton();
        newUserBt = new javax.swing.JButton();
        addUsers = new javax.swing.JButton();
        removeUsers = new javax.swing.JButton();
        closeBt = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        delGroupBt = new javax.swing.JButton();
        deluserBt = new javax.swing.JButton();
        setName("Form");
        jScrollPane1.setName("jScrollPane1");
        availableUsers.setMaximumSize(new java.awt.Dimension(40, 80));
        availableUsers.setMinimumSize(new java.awt.Dimension(40, 80));
        availableUsers.setName("availableUsers");
        availableUsers.addMouseListener(new java.awt.event.MouseAdapter() {

            public void mouseClicked(java.awt.event.MouseEvent evt) {
                availableUsersMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(availableUsers);
        jScrollPane2.setName("jScrollPane2");
        members.setMaximumSize(new java.awt.Dimension(40, 80));
        members.setMinimumSize(new java.awt.Dimension(40, 80));
        members.setName("members");
        jScrollPane2.setViewportView(members);
        groupsCb.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));
        groupsCb.setName("groupsCb");
        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(hu.rsc.svnAdmin.SVNAdmin.class).getContext().getResourceMap(UsersAndGroupsView.class);
        addGroupBt.setText(resourceMap.getString("addGroupBt.text"));
        addGroupBt.setName("addGroupBt");
        addGroupBt.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addGroupBtActionPerformed(evt);
            }
        });
        newUserBt.setText(resourceMap.getString("newUserBt.text"));
        newUserBt.setName("newUserBt");
        newUserBt.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                newUserBtActionPerformed(evt);
            }
        });
        addUsers.setText(resourceMap.getString("addUsers.text"));
        addUsers.setName("addUsers");
        addUsers.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addUsersActionPerformed(evt);
            }
        });
        removeUsers.setText(resourceMap.getString("removeUsers.text"));
        removeUsers.setName("removeUsers");
        removeUsers.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                removeUsersActionPerformed(evt);
            }
        });
        closeBt.setText(resourceMap.getString("closeBt.text"));
        closeBt.setName("closeBt");
        closeBt.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                closeBtActionPerformed(evt);
            }
        });
        jLabel1.setText(resourceMap.getString("jLabel1.text"));
        jLabel1.setName("jLabel1");
        jLabel2.setText(resourceMap.getString("jLabel2.text"));
        jLabel2.setName("jLabel2");
        jLabel3.setText(resourceMap.getString("jLabel3.text"));
        jLabel3.setName("jLabel3");
        delGroupBt.setText(resourceMap.getString("delGroupBt.text"));
        delGroupBt.setName("delGroupBt");
        delGroupBt.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                delGroupBtActionPerformed(evt);
            }
        });
        deluserBt.setText(resourceMap.getString("deluserBt.text"));
        deluserBt.setName("deluserBt");
        deluserBt.addActionListener(new java.awt.event.ActionListener() {

            public void actionPerformed(java.awt.event.ActionEvent evt) {
                deluserBtActionPerformed(evt);
            }
        });
        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(layout.createSequentialGroup().addContainerGap().addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(layout.createSequentialGroup().addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING).addGroup(javax.swing.GroupLayout.Alignment.LEADING, layout.createSequentialGroup().addComponent(jLabel3).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jLabel1).addComponent(groupsCb, javax.swing.GroupLayout.PREFERRED_SIZE, 190, javax.swing.GroupLayout.PREFERRED_SIZE))).addComponent(jScrollPane2, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.PREFERRED_SIZE, 279, javax.swing.GroupLayout.PREFERRED_SIZE)).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 39, Short.MAX_VALUE).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup().addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING).addComponent(removeUsers).addComponent(addUsers)).addGap(18, 18, 18).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(layout.createSequentialGroup().addComponent(addGroupBt).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(delGroupBt)).addGroup(layout.createSequentialGroup().addGap(86, 86, 86).addComponent(newUserBt).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(deluserBt)).addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 297, javax.swing.GroupLayout.PREFERRED_SIZE)).addGap(118, 118, 118)).addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup().addComponent(jLabel2).addGap(138, 138, 138)))).addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup().addComponent(closeBt).addGap(134, 134, 134)))));
        layout.setVerticalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(layout.createSequentialGroup().addGap(25, 25, 25).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(groupsCb, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE).addComponent(addGroupBt).addComponent(jLabel3).addComponent(delGroupBt)).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(layout.createSequentialGroup().addGap(7, 7, 7).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(jLabel1).addComponent(jLabel2)).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING).addComponent(jScrollPane1).addComponent(jScrollPane2, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 130, Short.MAX_VALUE))).addGroup(layout.createSequentialGroup().addGap(51, 51, 51).addComponent(addUsers).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED).addComponent(removeUsers))).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(newUserBt).addComponent(deluserBt)).addGap(47, 47, 47).addComponent(closeBt).addGap(86, 86, 86)));
    }

    private void closeBtActionPerformed(java.awt.event.ActionEvent evt) {
        SVNAdminView v = (SVNAdminView) SVNAdmin.getApplication().getMainView();
        v.updatePermissionsLists();
        v.usersAndGroupsView.setVisible(false);
    }

    /**
     * Create new group
     * @param evt
     */
    private void addGroupBtActionPerformed(java.awt.event.ActionEvent evt) {
        String group = (String) JOptionPane.showInputDialog(this, "Enter group name:");
        if (group != null && group.length() > 0) {
            if (!SVNAdminView.engine.isGroupExist(group)) {
                this.selectedGroup = SVNAdminView.engine.createGroup(group);
                updateComponents();
            } else {
                JOptionPane.showMessageDialog(this, "The group name: " + group + " already exist!");
            }
        }
    }

    /**
     * Delete the selected group
     * @param evt
     */
    private void delGroupBtActionPerformed(java.awt.event.ActionEvent evt) {
        if (selectedGroup != null) {
            int response = JOptionPane.showConfirmDialog(null, "Do you want to delete the selected group?", "Confirm", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
            if (response == JOptionPane.NO_OPTION) {
                System.out.println("No button clicked");
            } else if (response == JOptionPane.YES_OPTION) {
                SVNAdminView.engine.deleteGroup(selectedGroup);
                updateComponents();
            } else if (response == JOptionPane.CLOSED_OPTION) {
                System.out.println("JOptionPane closed");
            }
        } else {
            JOptionPane.showMessageDialog(this, "No selected group!");
        }
    }

    private void newUserBtActionPerformed(java.awt.event.ActionEvent evt) {
        JFrame mainFrame = SVNAdmin.getApplication().getMainFrame();
        userDialog = new UserDialog(mainFrame, true, null);
        userDialog.setLocationRelativeTo(mainFrame);
        SVNAdmin.getApplication().show(userDialog);
    }

    private void addUsersActionPerformed(java.awt.event.ActionEvent evt) {
        if (selectedGroup == null) {
            JOptionPane.showMessageDialog(this, "No selected group!");
            return;
        }
        Object[] selected = availableUsers.getSelectedValues();
        for (int i = 0; i < selected.length; i++) {
            SvnUser user = (SvnUser) selected[i];
            SVNAdminView.engine.addUserToGroup(selectedGroup, user);
            updateComponents();
        }
    }

    private void removeUsersActionPerformed(java.awt.event.ActionEvent evt) {
        if (selectedGroup == null) {
            JOptionPane.showMessageDialog(this, "No selected group!");
            return;
        }
        Object[] selected = members.getSelectedValues();
        for (int i = 0; i < selected.length; i++) {
            SvnUser user = (SvnUser) selected[i];
            SVNAdminView.engine.removeUserFromGroup(selectedGroup, user);
            updateComponents();
        }
    }

    private void deluserBtActionPerformed(java.awt.event.ActionEvent evt) {
        Object[] selected = availableUsers.getSelectedValues();
        for (int i = 0; i < selected.length; i++) {
            SvnUser user = (SvnUser) selected[i];
            SVNAdminView.engine.deleteUser(user);
        }
        updateComponents();
    }

    private void availableUsersMouseClicked(java.awt.event.MouseEvent evt) {
        if (evt.getClickCount() == 2) {
            int index = availableUsers.locationToIndex(evt.getPoint());
            if (index < 0) return;
            ListModel dlm = availableUsers.getModel();
            SvnUser user = (SvnUser) dlm.getElementAt(index);
            availableUsers.ensureIndexIsVisible(index);
            JFrame mainFrame = SVNAdmin.getApplication().getMainFrame();
            userDialog = new UserDialog(mainFrame, true, user);
            userDialog.setLocationRelativeTo(mainFrame);
            SVNAdmin.getApplication().show(userDialog);
        }
    }

    private javax.swing.JButton addGroupBt;

    private javax.swing.JButton addUsers;

    private javax.swing.JList availableUsers;

    private javax.swing.JButton closeBt;

    private javax.swing.JButton delGroupBt;

    private javax.swing.JButton deluserBt;

    private javax.swing.JComboBox groupsCb;

    private javax.swing.JLabel jLabel1;

    private javax.swing.JLabel jLabel2;

    private javax.swing.JLabel jLabel3;

    private javax.swing.JScrollPane jScrollPane1;

    private javax.swing.JScrollPane jScrollPane2;

    private javax.swing.JList members;

    private javax.swing.JButton newUserBt;

    private javax.swing.JButton removeUsers;
}
