package com.vangent.hieos.xtest.transactions.xds;

import com.vangent.hieos.xtest.framework.BasicTransaction;
import com.vangent.hieos.xtest.framework.StepContext;
import com.vangent.hieos.xutil.metadata.structure.MetadataTypes;
import com.vangent.hieos.xutil.exception.ExceptionUtil;
import com.vangent.hieos.xutil.exception.XdsException;
import com.vangent.hieos.xutil.exception.XdsInternalException;
import com.vangent.hieos.xutil.metadata.structure.Metadata;
import com.vangent.hieos.xutil.metadata.structure.MetadataParser;
import com.vangent.hieos.xtest.framework.TestConfig;
import com.vangent.hieos.xutil.xml.Util;
import java.io.File;
import java.util.Iterator;
import org.apache.axiom.om.OMElement;
import org.apache.axiom.om.OMNamespace;
import org.apache.axis2.AxisFault;
import org.apache.axis2.addressing.EndpointReference;
import org.apache.axis2.client.Options;
import org.apache.axis2.client.ServiceClient;

public class SqlQueryTransaction extends QueryTransaction {

    public SqlQueryTransaction(StepContext s_ctx, OMElement instruction, OMElement instruction_output) {
        super(s_ctx, instruction, instruction_output);
    }

    public void run() throws XdsException {
        String metadata_filename = null;
        OMElement metadata = null;
        OMElement expected_contents = null;
        Iterator elements = instruction.getChildElements();
        while (elements.hasNext()) {
            OMElement part = (OMElement) elements.next();
            String part_name = part.getLocalName();
            if (part_name.equals("MetadataFile")) {
                metadata_filename = TestConfig.base_path + part.getText();
                s_ctx.add_name_value(instruction_output, "MetadataFile", metadata_filename);
            } else if (part_name.equals("Metadata")) {
                metadata_filename = "";
                metadata = part.getFirstElement();
            } else if (part_name.equals("ExpectedContents")) {
                expected_contents = part;
                s_ctx.add_name_value(instruction_output, "ExpectedContents", part);
            } else if (part_name.equals("UseId")) {
                use_id.add(part);
                s_ctx.add_name_value(instruction_output, "UseId", part);
            } else throw new XdsException("Don't understand instruction " + part_name + " inside step " + s_ctx.getId());
        }
        xds_version = BasicTransaction.xds_a;
        parseEndpoint("q");
        if (metadata_filename == null && metadata == null) throw new XdsInternalException("No MetadataFile element or Metadata element found for QueryTransaction instruction within step " + s_ctx.get("step_id"));
        OMElement metadata_ele = null;
        if (metadata != null) metadata_ele = metadata; else metadata_ele = Util.parse_xml(new File(metadata_filename));
        Metadata m = MetadataParser.noParse(metadata_ele);
        if (use_id.size() > 0) compileUseIdLinkage(m, use_id);
        s_ctx.add_name_value(instruction_output, "InputMetadata", Util.deep_copy(metadata_ele));
        OMNamespace ns = metadata_ele.getNamespace();
        String ns_uri = ns.getNamespaceURI();
        int metadata_type = 0;
        if (ns_uri.equals("urn:oasis:names:tc:ebxml-regrep:xsd:query:3.0")) {
            metadata_type = MetadataTypes.METADATA_TYPE_SQ;
        } else if (ns_uri.equals("urn:oasis:names:tc:ebxml-regrep:query:xsd:2.1")) {
            metadata_type = MetadataTypes.METADATA_TYPE_Q;
        } else {
            throw new XdsInternalException("Don't understand version of metadata (namespace on root element): " + ns_uri);
        }
        if (!metadata_ele.getLocalName().equals("AdhocQueryRequest")) throw new XdsInternalException("Query Transaction (as coded in testplan step '" + s_ctx.get("step_id") + "') must reference a file containing an AdhocQueryRequest");
        Options options = new Options();
        options.setTo(new EndpointReference(endpoint));
        try {
            ServiceClient serviceClient = new ServiceClient();
            serviceClient.setOptions(options);
            if (System.getenv("XDSHTTP10") != null) {
                System.out.println("Generating HTTP 1.0");
                serviceClient.getOptions().setProperty(org.apache.axis2.transport.http.HTTPConstants.HTTP_PROTOCOL_VERSION, org.apache.axis2.transport.http.HTTPConstants.HEADER_PROTOCOL_10);
                serviceClient.getOptions().setProperty(org.apache.axis2.transport.http.HTTPConstants.CHUNKED, Boolean.FALSE);
            }
            OMElement result = null;
            result = serviceClient.sendReceive(metadata_ele);
            s_ctx.add_name_value(instruction_output, "Result", result);
            validate_registry_response_no_set_status(result, metadata_type);
            if (expected_contents != null) {
                String errors = validate_expected_contents(result, metadata_type, expected_contents);
                if (errors.length() > 0) {
                    s_ctx.set_error(errors);
                    failed();
                }
            }
            add_step_status_to_output();
        } catch (AxisFault e) {
            throw new XdsInternalException(ExceptionUtil.exception_details(e));
        }
    }

    @Override
    protected String getRequestAction() {
        return null;
    }
}
